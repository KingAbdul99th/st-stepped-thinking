<div id="stepthink_settings">
    <div class="inline-drawer">
        <div class="inline-drawer-toggle inline-drawer-header">
            <b>Stepped Thinking</b>
            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
        </div>
        <div class="inline-drawer-content">
            <div class="flex-container justifySpaceBetween flexFlowRow">
                <div class="flex-container marginTopBot5">
                    <label class="checkbox_label expander" for="stepthink_is_enabled"
                        title="Trigger thoughts generation every time a new message is generated">
                        <input id="stepthink_is_enabled" type="checkbox"/>
                        Enable thinking on each message
                    </label>
                </div>

                <div class="flex-container marginTopBot5 indent20p">
                    <div id="stepthink_is_shutdown" class="menu_button margin0 fa-solid fa-power-off stepthink_mode_embedded"
                         title="Completely shut down/turn on the extension, including hiding/revealing already existing thoughts. The page will be reloaded">
                    </div>
                </div>
            </div>
            
			<!-- Connection Profile -->
			<div class="stepthink-block m-b-1 m-t-1">
				<label for="stepthink_connection_profile">Connection Profile</label><br />
				<small>Override connection profile for stepthink generation:</small><br />
				<select id="stepthink_connection_profile" class="text_pole">
					<option value="current">Same as current</option>
				</select>
			</div>

			<!-- Completion Preset -->
			<div class="stepthink-block m-b-1 m-t-1">
				<label for="stepthink_completion_preset">Completion preset</label><br />
				<small>
					Override completion preset for stepthink generation: <br />
					(For Chat Completion Profiles, Make sure the preset has the same Chat completion Source as the profile)
				</small><br />
				<select id="stepthink_completion_preset" class="text_pole">
					<option value="current">Same as current</option>
				</select>
			</div>

            <div class="flex-container alignItemsCenter">
                Thinking mode:
                <select id="stepthink_mode" class="text_pole widthNatural">
                </select>
            </div>

            <hr/>

            <div class="flex-container justifySpaceBetween alignItemsCenter">
                Prompts for thinking:
                <div id="stepthink_prompt_list_add"
                     class="menu_button menu_button_icon fa-solid fa-plus"
                     title="Add prompt"></div>
            </div>

            <div id="stepthink_prompt_list"></div>

            <div class="flex-container marginTopBot5">
                <label class="checkbox_label expander" for="stepthink_is_wian_skipped"
                       title="Omit World Info and Author's Note from thought generation prompts">
                    <input id="stepthink_is_wian_skipped" type="checkbox"/>
                    Skip WI/AN
                </label>
            </div>

            <div class="flex-container marginTopBot5 stepthink_mode_separated">
                <label class="checkbox_label expander" for="stepthink_is_thoughts_as_system"
                       title="Include character thoughts messages as the System role">
                    <input id="stepthink_is_thoughts_as_system" type="checkbox"/>
                    Thoughts as System
                </label>
            </div>

            <div class="flex-container alignItemsCenter marginTopBot5 stepthink_mode_embedded">
                Role for sending thoughts:
                <select id="stepthink_sending_thoughts_role" class="text_pole widthNatural">
                    <option value="0">System</option>
                    <option value="1">User</option>
                    <option value="2">Assistant</option>
                </select>
            </div>

            <hr/>

            <div class="flex-container marginTopBot5">
                <div class="flex-container flex1"
                     title="The number of a character's last messages with thoughts that will be included in the generation prompt">
                    <label for="stepthink_max_thoughts_in_prompt">
                        Number of last thoughts included in prompt:
                    </label>
                    <input type="number" id="stepthink_max_thoughts_in_prompt" class="text_pole" min="0"/>
                </div>
            </div>

            <div class="flex-container marginTopBot5 stepthink_mode_embedded">
                <label class="checkbox_label expander" for="stepthink_is_always_include_ongoing_thoughts"
                       title='Whether the thought that is currently being generated will always be included in the prompt without increasing the counter set by the "Number of last thoughts included in prompt" setting'>
                    <input id="stepthink_is_always_include_ongoing_thoughts" type="checkbox"/>
                    Always include ongoing thoughts
                </label>
            </div>

            <hr class="stepthink_mode_embedded"/>

            <div class="flex-container justifySpaceBetween alignItemsCenter">
                <label for="stepthink_character_settings"
                       title="You can set up individual settings for selected characters. Click on a characterâ€™s name after the character is added to the list to adjust its settings">
                    Character settings (click on a name to adjust):
                </label>
                <div id="stepthink_load_characters"
                     class="menu_button menu_button_icon fa-solid fa-undo"
                     title="Reload characters list"></div>
                <select id="stepthink_character_settings" class="select2_multi_sameline"
                        multiple="multiple"></select>
            </div>

            <div class="flex-container marginTopBot5">
                <div id="stepthink_additional_settings_toggle" class="menu_button menu_button_icon">
                    <i class="fa-solid fa-cog"></i>
                    Additional Settings
                </div>
            </div>
            <div id="stepthink_additional_settings" style="display:none;">
                <div class="flex-container marginTopBot5">
                    <label class="checkbox_label expander" for="stepthink_is_thoughts_spoiler_open"
                           title="Whether spoilers will be open or closed in new messages. It doesn't affect existing ones">
                        <input id="stepthink_is_thoughts_spoiler_open" type="checkbox"/>
                        Thought spoilers are open by default
                    </label>
                </div>

                <div class="flex-container marginTopBot5">
                    <label class="checkbox_label expander" for="stepthink_is_thinking_popups_enabled"
                           title="Whether popups notifying about the progress of thinking will be shown">
                        <input id="stepthink_is_thinking_popups_enabled" type="checkbox"/>
                        Enable popups when a character is thinking
                    </label>
                </div>

                <div class="flex-container marginTopBot5">
                    <div class="flex-container flex1"
                         title="The minimum length of a generated thought in characters. If a generated thought is less than or equal to the specified length, another generation attempt will be triggered, and so on, until the length exceeds the specified value">
                        <label for="stepthink_min_thought_length">
                            Minimum thought length (characters):
                        </label>
                        <input type="number" id="stepthink_min_thought_length" class="text_pole" min="0"/>
                    </div>
                </div>

                <div class="flex-container marginTopBot5">
                    <div class="flex-container flex1"
                         title="This setting restricts the response length for generated thoughts. The generation will stop when the thought reaches the specified length. Set to 0 to disable.">
                        <label for="stepthink_max_response_length">
                            Maximum thought length (tokens):
                        </label>
                        <input type="number" id="stepthink_max_response_length" class="text_pole" min="0"/>
                    </div>
                </div>

                <div class="flex-container marginTopBot5">
                    <div class="flex-container flex1"
                         title="Certain APIs may experience issues when attempting too many generations in a short time; this option lets you set up a delay before each generation request. Fractional numbers are allowed">
                        <label for="stepthink_generation_delay">
                            Delay generation requests (seconds):
                        </label>
                        <input type="number" id="stepthink_generation_delay" class="text_pole" min="0"/>
                    </div>
                </div>

                <div class="flex-container marginTopBot5">
                    <div class="flex-container flex1"
                         title="This number defines the maximum messages inspected, starting from the last one, to determine for which of them thoughts should be hidden">
                        <label for="stepthink_max_hiding_thoughts_lookup">
                            Maximum messages to inspect for hiding:
                        </label>
                        <input type="number" id="stepthink_max_hiding_thoughts_lookup" class="text_pole" min="0"/>
                    </div>
                </div>

                <div class="flex-container marginTopBot5">
                    <div class="flex-container justifySpaceBetween alignItemsCenter flex1"
                         title="Often, there are special symbols and other shiza in the generation output; it will be removed by the regexp">
                        <label for="stepthink_regexp_to_sanitize">
                            Regexp to sanitize thoughts:
                        </label>
                        <div id="stepthink_restore_regexp_to_sanitize" class="menu_button margin0" title="Restore default regexp">Default</div>
                        <input type="text" id="stepthink_regexp_to_sanitize" class="text_pole textarea_compact"/>
                    </div>
                </div>

                <hr/>

                <!-- embedded thoughts -->
                <div class="flex-container marginTopBot5 stepthink_mode_embedded">
                    <label for="stepthink_thoughts_block_title"
                           title="This string will be used as a header for the thoughts block. It won't be sent in the prompt">
                        Thoughts UI block title:
                    </label>
                    <input type="text" id="stepthink_thoughts_block_title" class="text_pole textarea_compact"/>
                </div>

                <div class="flex-container alignItemsCenter stepthink_mode_embedded">
                    <label for="stepthink_thoughts_prefix_injection_mode"
                           title='This setting controls when the "Thoughts injection prefix" will be injected. You might want to disable prefix injection for Instruct or Chat Completions modes, or you can use "Import from settings" to automatically determine when prefix injection is required'>
                        Prefix injection mode:
                    </label>
                    <select id="stepthink_thoughts_prefix_injection_mode" class="text_pole widthNatural">
                        <option value="always">Always</option>
                        <option value="groups">Only Group chats</option>
                        <option value="from_instruct">Import from settings</option>
                        <option value="never">Never</option>
                    </select>
                </div>

                <div class="flex-container marginTopBot5 stepthink_mode_embedded">
                    <label for="stepthink_thoughts_injection_prefix"
                           title="This string will replace the macro {{prefix}} if it is allowed by the prefix injection mode">
                        Thoughts injection prefix:
                    </label>
                    <input type="text" id="stepthink_thoughts_injection_prefix" class="text_pole textarea_compact"/>
                </div>

                <div class="flex-container marginTopBot5 stepthink_mode_embedded">
                    <div class="flex-container justifySpaceBetween alignItemsCenter flex1">
                        <label for="stepthink_general_injection_template"
                               title="This template will be rendered and passed in the resulting prompt. Additional macros: {{prefix}}, {{thoughts)}}">
                            General thoughts injection template:
                        </label>
                        <textarea id="stepthink_general_injection_template" class="text_pole textarea_compact" rows="3"></textarea>
                    </div>
                </div>

                <div class="flex-container marginTopBot5 stepthink_mode_embedded">
                    <div class="flex-container justifySpaceBetween alignItemsCenter flex1">
                        <label for="stepthink_thought_injection_template"
                               title="This template will replace the {{thoughts}} macro in the general template, rendering each thought separated by the specified separator. Additional macros: {{thought}}, {{prompt_name}}, {{prompt_name.toLowerCase()}}">
                            Thought injection template:
                        </label>
                        <div id="stepthink_restore_thought_injection_template" class="menu_button margin0" title="Restore default thought injection template">Default</div>
                        <textarea id="stepthink_thought_injection_template" class="text_pole textarea_compact" rows="3"></textarea>
                    </div>
                </div>

                <div class="flex-container marginTopBot5 stepthink_mode_embedded">
                    <div class="flex-container justifySpaceBetween alignItemsCenter flex1">
                        <label for="stepthink_thought_injection_separator"
                               title="This string will be used to separate thoughts in the prompt">
                            Thoughts injection separator:
                        </label>
                        <textarea id="stepthink_thought_injection_separator" class="text_pole textarea_compact" rows="2"></textarea>
                    </div>
                </div>

                <div class="flex-container marginTopBot5 stepthink_mode_embedded">
                    <label for="stepthink_thoughts_prompts_order_prefix"
                           title='This string defines the position of injected thought prompts among other extension prompts. The prompts are sorted alphabetically: setting it to "0" places the prompt first, while "Z" places it last. Leave it empty if you are fine with the default order of extension prompts'>
                        Extension injection order prefix:
                    </label>
                    <input type="text" id="stepthink_thoughts_prompts_order_prefix" class="text_pole textarea_compact"/>
                </div>
                <!-- embedded thoughts -->

                <!-- separated thoughts -->
                <div class="flex-container marginTopBot5 stepthink_mode_separated">
                    <div class="flex-container justifySpaceBetween alignItemsCenter flex1">
                        <label for="stepthink_system_character_name_template"
                               title="This name will be used when thoughts are sent from the System role">
                            System name template:
                        </label>
                        <input type="text" id="stepthink_system_character_name_template" class="text_pole textarea_compact"/>
                    </div>
                </div>

                <div class="flex-container marginTopBot5 stepthink_mode_separated">
                    <div class="flex-container flexFlowColumn flex1">
                        <div class="flex-container flexFlowRow alignItemsStart justifySpaceBetween">
                            <label title="A set of fields used to fill the {{thoughts_placeholder}} macro">
                                Thoughts placeholder:
                            </label>
                            <div id="stepthink_restore_thoughts_placeholder" class="menu_button margin0" title="Restore default thoughts placeholder">Default</div>
                        </div>

                        <div class="flex-container flexFlowColumn">
                            <div class="flex-container flexFlowRow">
                                <div class="flex-container flexFlowRow alignItemsCenter">
                                    <small title="The beginning of a thought block">
                                        Start:
                                    </small>
                                    <input type="text" id="stepthink_thoughts_placeholder_start" class="text_pole textarea_compact"/>
                                </div>
                                <div class="flex-container flexFlowRow alignItemsCenter marginLeft5">
                                    <small title="The placeholder that is used when thinking generation is in progress">
                                        Default:
                                    </small>
                                    <input type="text" id="stepthink_thoughts_placeholder_default_content" class="text_pole textarea_compact"/>
                                </div>
                                <div class="flex-container flexFlowRow alignItemsCenter marginLeft5">
                                    <small title="The end of a thought block. Be careful: this string must be unique and should not appear within thoughts! Otherwise, the extension may behave unpredictably">
                                        End:
                                    </small>
                                    <input type="text" id="stepthink_thoughts_placeholder_end" class="text_pole textarea_compact"/>
                                </div>
                            </div>
                            <div class="flex-container">
                                <div class="flex-container flexFlowRow alignItemsCenter width100p">
                                    <small title="The content of a thought block after the thought is generated. Additional macros: {{thoughts}}">
                                        Content:
                                    </small>
                                    <textarea id="stepthink_thoughts_placeholder_content" class="text_pole textarea_compact" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex-container marginTopBot5 stepthink_mode_separated">
                    <div class="flex-container justifySpaceBetween alignItemsCenter flex1"
                         title="This name will be used when thoughts are sent from the System role. Additional macros: {{thoughts_spoiler_open_state}}, {{thoughts_placeholder}}">
                        <label for="stepthink_thoughts_message_template">
                            Template for a thoughts message:
                        </label>
                        <div id="stepthink_restore_thoughts_message_template" class="menu_button margin0" title="Restore default thoughts message template">Default</div>
                        <textarea id="stepthink_thoughts_message_template" class="text_pole textarea_compact" rows="6"></textarea>
                    </div>
                </div>
                <!-- separated thoughts -->
            </div>
        </div>
    </div>
</div>
